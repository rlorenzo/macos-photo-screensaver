# Architecture Diagram

## Component Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    macOS System                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            Screen Saver Settings                       â”‚  â”‚
â”‚  â”‚  (System Settings > Screen Saver)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â”‚ Launches                            â”‚
â”‚                        â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         PhotoScreensaver.saver Bundle                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚      PhotoScreensaverView                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (Main ScreenSaverView subclass)                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                   â”‚                                    â”‚  â”‚
â”‚  â”‚                   â”‚ Manages                            â”‚  â”‚
â”‚  â”‚                   â–¼                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚       Component Manager                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ NSImageView  â”‚  â”‚ Timer       â”‚             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ (Display)    â”‚  â”‚ (Rotation)  â”‚             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ PHCachingImageManager        â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ (Photo Loading)              â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â”‚ Requests Access                     â”‚
â”‚                        â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              PhotoKit Framework                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  PHPhotoLibrary                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Authorization                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Asset Fetching                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â”‚ Accesses                            â”‚
â”‚                        â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Photos Library                            â”‚  â”‚
â”‚  â”‚  ðŸ“· ðŸ“· ðŸ“· ðŸ“· ðŸ“· ðŸ“· ðŸ“· ðŸ“· ðŸ“· ðŸ“·                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

```
1. Initialization
   â””â”€> PhotoScreensaverView.init()
       â””â”€> setup()
           â”œâ”€> Create NSImageView
           â”œâ”€> Initialize PHCachingImageManager
           â””â”€> requestPhotoLibraryAccess()

2. Authorization
   â””â”€> PHPhotoLibrary.authorizationStatus()
       â”œâ”€> If authorized â”€â”€> loadPhotos()
       â”œâ”€> If denied â”€â”€â”€â”€â”€â”€> showAccessDeniedMessage()
       â””â”€> If undetermined â”€> requestAuthorization()

3. Photo Loading
   â””â”€> loadPhotos()
       â””â”€> PHAsset.fetchAssets()
           â”œâ”€> Filter: mediaType == image
           â”œâ”€> Sort: by creationDate
           â””â”€> Store in photos array
               â”œâ”€> If empty â”€> showNoPhotosMessage()
               â””â”€> If found â”€> startRotation()

4. Rotation System
   â””â”€> startRotation()
       â”œâ”€> displayCurrentPhoto() [immediate]
       â””â”€> Timer.scheduledTimer() [repeating]
           â””â”€> Every 5 seconds
               â””â”€> rotateToNextPhoto()
                   â”œâ”€> Increment index (with wrap)
                   â””â”€> displayCurrentPhoto()

5. Photo Display
   â””â”€> displayCurrentPhoto()
       â””â”€> imageManager.requestImage()
           â”œâ”€> Parameters:
           â”‚   â”œâ”€> Asset: photos[currentIndex]
           â”‚   â”œâ”€> Size: 2x screen bounds
           â”‚   â”œâ”€> Mode: aspectFit
           â”‚   â””â”€> Options: highQuality, allowNetwork
           â”‚
           â””â”€> On completion:
               â””â”€> Transition Animation
                   â”œâ”€> Fade out (0.5s) â”€â”€> Alpha: 1.0 â†’ 0.0
                   â”œâ”€> Swap image
                   â””â”€> Fade in (0.5s) â”€â”€â”€> Alpha: 0.0 â†’ 1.0
```

## State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Initial   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Requesting Auth â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
       â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Authorizedâ”‚   â”‚   Denied    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Loading  â”‚   â”‚Show Error   â”‚
â”‚ Photos   â”‚   â”‚  Message    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Has Photosâ”‚   â”‚  No Photos  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Displayingâ”‚   â”‚Show Error   â”‚
â”‚  Photos  â”‚   â”‚  Message    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ (Timer fires every 5s)
     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Rotate    â”‚
         â”‚  to Next    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â””â”€â”€â”€â”€â”€> (Back to Displaying)
```

## Class Hierarchy

```
NSObject
  â””â”€> NSView
       â””â”€> ScreenSaverView (ScreenSaver.framework)
            â””â”€> PhotoScreensaverView (Custom Implementation)
                 â”‚
                 â”œâ”€> Properties:
                 â”‚    â”œâ”€> imageView: NSImageView!
                 â”‚    â”œâ”€> photos: [PHAsset]
                 â”‚    â”œâ”€> currentPhotoIndex: Int
                 â”‚    â”œâ”€> rotationTimer: Timer?
                 â”‚    â”œâ”€> imageManager: PHCachingImageManager!
                 â”‚    â””â”€> isAuthorized: Bool
                 â”‚
                 â”œâ”€> Initialization:
                 â”‚    â”œâ”€> init(frame:isPreview:)
                 â”‚    â”œâ”€> init(coder:)
                 â”‚    â””â”€> deinit
                 â”‚
                 â”œâ”€> Setup:
                 â”‚    â””â”€> setup()
                 â”‚
                 â”œâ”€> Photo Library:
                 â”‚    â”œâ”€> requestPhotoLibraryAccess()
                 â”‚    â”œâ”€> showAccessDeniedMessage()
                 â”‚    â”œâ”€> loadPhotos()
                 â”‚    â””â”€> showNoPhotosMessage()
                 â”‚
                 â”œâ”€> Photo Rotation:
                 â”‚    â”œâ”€> startRotation()
                 â”‚    â”œâ”€> rotateToNextPhoto()
                 â”‚    â””â”€> displayCurrentPhoto()
                 â”‚
                 â””â”€> Overrides:
                      â”œâ”€> startAnimation()
                      â”œâ”€> stopAnimation()
                      â”œâ”€> animateOneFrame()
                      â””â”€> hasConfigureSheet
```

## Thread Safety

```
Main Thread (UI)
â”œâ”€> NSImageView updates
â”œâ”€> NSAnimationContext
â”œâ”€> Timer callbacks
â””â”€> User interaction

Background Thread (PhotoKit)
â”œâ”€> PHPhotoLibrary operations
â”œâ”€> PHAsset fetching
â””â”€> Image loading requests

Synchronization
â””â”€> DispatchQueue.main.async
    â””â”€> Used for all UI updates from background
```

## Memory Management

```
Strong References
â”œâ”€> imageView (retained by view hierarchy)
â”œâ”€> photos array (owned by instance)
â””â”€> imageManager (owned by instance)

Weak References
â”œâ”€> [weak self] in closures
â”‚   â”œâ”€> Timer callbacks
â”‚   â”œâ”€> PhotoKit completions
â”‚   â””â”€> Animation completions
â”‚
â””â”€> Prevents retain cycles

Cleanup
â””â”€> deinit
    â””â”€> rotationTimer?.invalidate()
```

## Error Handling

```
Photo Library Access
â”œâ”€> Authorization Status Check
â”‚   â”œâ”€> .authorized â”€â”€â”€â”€â”€â”€> âœ“ Continue
â”‚   â”œâ”€> .limited â”€â”€â”€â”€â”€â”€â”€â”€â”€> âœ“ Continue (partial)
â”‚   â”œâ”€> .denied â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> âœ— Show error
â”‚   â”œâ”€> .restricted â”€â”€â”€â”€â”€â”€> âœ— Show error
â”‚   â”œâ”€> .notDetermined â”€â”€â”€> ? Request permission
â”‚   â””â”€> @unknown default â”€> âœ— Show error
â”‚
â”œâ”€> Photo Fetching
â”‚   â”œâ”€> Success with photos â”€> âœ“ Display
â”‚   â””â”€> Success, no photos â”€â”€> âœ— Show "no photos"
â”‚
â””â”€> Image Loading
    â”œâ”€> Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> âœ“ Display with transition
    â””â”€> Failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Silent fail, try next
```
