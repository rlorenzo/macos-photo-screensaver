name: Build and Lint
permissions:
  contents: read

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build PhotoScreensaver
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: List available Xcode versions
      run: ls -la /Applications/ | grep Xcode

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show Swift version
      run: swift --version

    - name: Build PhotoScreensaver (Debug)
      run: |
        set -o pipefail
        xcodebuild \
          -project PhotoScreensaver.xcodeproj \
          -scheme PhotoScreensaver \
          -configuration Debug \
          build \
          CONFIGURATION_BUILD_DIR="$PWD/build/Debug" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          2>&1 | tee build_debug.log

    - name: Show Debug build errors if failed
      if: failure()
      run: |
        echo "=== Swift Compilation Errors ==="
        grep -A 5 "error:" build_debug.log || echo "No explicit errors found"
        echo ""
        echo "=== Last 100 lines of build log ==="
        tail -100 build_debug.log

    - name: Build PhotoScreensaver (Release)
      run: |
        set -o pipefail
        xcodebuild \
          -project PhotoScreensaver.xcodeproj \
          -scheme PhotoScreensaver \
          -configuration Release \
          build \
          CONFIGURATION_BUILD_DIR="$PWD/build/Release" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          2>&1 | tee build_release.log

    - name: Verify build artifacts
      run: |
        echo "Checking Debug build..."
        ls -lh build/Debug/
        if [ ! -f "build/Debug/PhotoScreensaver.saver/Contents/MacOS/PhotoScreensaver" ]; then
          echo "❌ Debug build artifact not found!"
          exit 1
        fi
        echo "✅ Debug build artifact verified"

        echo ""
        echo "Checking Release build..."
        ls -lh build/Release/
        if [ ! -f "build/Release/PhotoScreensaver.saver/Contents/MacOS/PhotoScreensaver" ]; then
          echo "❌ Release build artifact not found!"
          exit 1
        fi
        echo "✅ Release build artifact verified"

    - name: Upload Debug build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PhotoScreensaver-Debug
        path: build/Debug/PhotoScreensaver.saver
        retention-days: 7

    - name: Upload Release build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PhotoScreensaver-Release
        path: build/Release/PhotoScreensaver.saver
        retention-days: 30

  lint:
    name: SwiftLint
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: |
        swiftlint version
        swiftlint lint --strict
